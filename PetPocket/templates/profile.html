<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReWear - Profile</title>
  <!-- Add CSRF token meta tag before other resources -->
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{url_for('static', filename='css/navbar.css')}}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=Inter:wght@800&display=swap" rel="stylesheet">
  <style>
    body, .tab-content, .info-value, .detail-section, .addresses-grid, .address-card, .purchase-card, .purchase-item, .add-item-form, .stat-content p, .points-bar, .tab-button, .shop-now-btn, .create-request-btn {
      font-family: 'Crimson Pro', serif !important;
    }
    h1, h2, h3, .profile-username, .detail-section h3, .stat-content h4, .default-badge, .tab-header, .stat-card span.material-symbols-outlined {
      font-family: 'Inter', sans-serif !important;
      font-weight: 800 !important;
      letter-spacing: -0.5px;
    }
    .refresh-btn {
      background: none;
      border: none;
      color: #ffca28;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.3s ease;
      margin-left: 8px;
    }
    .refresh-btn:hover {
      background: rgba(255, 202, 40, 0.1);
      transform: rotate(180deg);
    }
    .refresh-btn .material-symbols-outlined {
      font-size: 16px;
    }
    .approval-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      margin-top: 4px;
    }
    .approval-status.approved {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .approval-status.pending {
      background: #fff3e0;
      color: #ef6c00;
    }
    .approval-status.rejected {
      background: #ffebee;
      color: #c62828;
    }
    .rejection-reason {
      font-size: 0.85rem;
      color: #c62828;
      font-style: italic;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  {% include 'navbar.html' %}
  
  <div class="profile-container">
    <!-- Profile Header with Points -->
    <div class="profile-header">
      <div class="profile-hero">
        <div class="profile-avatar">
          {% if current_user.profile_picture %}
            <img src="{{ current_user.profile_picture }}" alt="{{ current_user.username }}" class="profile-photo">
          {% else %}
            <span class="material-symbols-outlined profile-icon">pets</span>
          {% endif %}
        </div>
        <div class="profile-main-info">
          <div class="profile-header-row">
            <h2 class="profile-username">{{ current_user.username }}</h2>
            <button class="edit-button" id="edit-profile-btn">
              <span class="material-symbols-outlined">edit</span> Edit Profile
            </button>
          </div>
          <div class="points-bar">
            <span class="points-label">Points:</span>
            <span class="points-value" id="points-display">{{ current_user.points_balance }}</span>
            <span class="points-icon">ü™ô</span>
            <button id="refresh-points-btn" class="refresh-btn" onclick="refreshPoints()" title="Refresh Points">
              <span class="material-symbols-outlined">refresh</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="profile-tabs">
      <div class="tab-header">
        <button class="tab-button active" data-tab="dashboard">
          <span class="material-symbols-outlined">dashboard</span>
          Dashboard
        </button>
        <button class="tab-button" data-tab="swap-requests">
          <span class="material-symbols-outlined">swap_horiz</span>
          Swap History
        </button>
        <button class="tab-button" data-tab="add-item">
          <span class="material-symbols-outlined">add_circle</span>
          List Items
        </button>
        <button class="tab-button" data-tab="my-redemptions">
          <span class="material-symbols-outlined">stars</span>
          My Redemptions
        </button>
        <button class="tab-button" data-tab="personal-info">
          <span class="material-symbols-outlined">person</span>
          Personal Info
        </button>
      </div>

      <div class="tab-content">
        <!-- Dashboard Tab -->
        <div class="tab-pane active" id="dashboard">
          <div class="detail-section">
            <h3>Dashboard Overview</h3>
            <div class="dashboard-stats">
              <div class="stat-card">
                <span class="material-symbols-outlined">inventory_2</span>
                <div class="stat-content">
                  <h4>{{ uploaded_products|length if uploaded_products else 0 }}</h4>
                  <p>Items Listed</p>
                </div>
              </div>
              <div class="stat-card">
                <span class="material-symbols-outlined">favorite</span>
                <div class="stat-content">
                  <h4>{{ wishlist_items|length if wishlist_items else 0 }}</h4>
                  <p>Wishlist Items</p>
                </div>
              </div>

              <div class="stat-card">
                <span class="material-symbols-outlined">swap_horiz</span>
                <div class="stat-content">
                  <h4>{{ user_swaps|length if user_swaps else 0 }}</h4>
                  <p>Completed Swaps</p>
                </div>
              </div>
              
              <div class="stat-card">
                <span class="material-symbols-outlined">stars</span>
                <div class="stat-content">
                  <h4>{{ point_redemptions|length if point_redemptions else 0 }}</h4>
                  <p>Point Redemptions</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="detail-section">
            <h3>Recent Activity</h3>
            <div class="activity-list">
              {% if recent_activity %}
                {% for activity in recent_activity %}
                <div class="activity-item">
                  <span class="activity-icon material-symbols-outlined">{{ activity.icon }}</span>
                  <div class="activity-content">
                    <p class="activity-text">{{ activity.text }}</p>
                    <span class="activity-time">{{ activity.time }}</span>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="empty-state">
                  <span class="material-symbols-outlined">timeline</span>
                  <p>No recent activity.</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Swap Requests Tab -->
        <div class="tab-pane" id="swap-requests">
          <div class="detail-section">
            <h3>My Swap History</h3>
            {% if user_swaps and user_swaps|length > 0 %}
              <div class="swaps-carousel-container">
                <div class="swaps-carousel-header">
                  <div class="swap-counter">
                    <span id="current-swap-index">1</span> of {{ user_swaps|length }} swaps
                  </div>
                  <div class="carousel-controls">
                    <button class="carousel-btn prev" id="prev-swap" onclick="previousSwap()">
                      <span class="material-symbols-outlined">chevron_left</span>
                    </button>
                    <button class="carousel-btn next" id="next-swap" onclick="nextSwap()">
                      <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                  </div>
                </div>
                
                <div class="swaps-carousel">
                  {% for swap in user_swaps %}
                <div class="swap-card" data-swap-index="{{ loop.index0 }}" {% if loop.index0 == 0 %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                  <div class="swap-header">
                    <div class="swap-id-section">
                      <span class="swap-id">Swap #{{ swap.id }}</span>
                      <span class="swap-participants">
                        <span class="material-symbols-outlined">people</span>
                        {{ swap.user1.username }} ‚áÑ {{ swap.user2.username }}
                      </span>
                    </div>
                    <div class="swap-meta">
                      <span class="swap-date">
                        <span class="material-symbols-outlined">calendar_today</span>
                        {{ swap.completed_at.strftime('%B %d, %Y') }}
                      </span>
                      <span class="swap-status completed">
                        <span class="material-symbols-outlined">check_circle</span>
                        Completed
                      </span>
                    </div>
                  </div>
                  
                  <div class="swap-summary">
                    <p class="swap-description">
                      Successfully exchanged clothing items between 
                      <strong>{{ swap.user1.username }}</strong> and <strong>{{ swap.user2.username }}</strong>
                    </p>
                  </div>

                  <div class="swap-items">
                    {% if swap.user1_id == current_user.id %}
                      <div class="swap-item-pair">
                        <div class="swap-item my-item">
                          <div class="swap-item-header">
                            <span class="material-symbols-outlined">person</span>
                            <span class="swap-item-owner">Your Item</span>
                          </div>
                          <div class="swap-item-content">
                            <img src="{{ swap.item1.image_url }}" alt="{{ swap.item1.name }}" class="swap-item-image">
                            <div class="swap-item-details">
                              <h4 class="swap-item-name">{{ swap.item1.name }}</h4>
                              <p class="swap-item-category">{{ swap.item1.category.name if swap.item1.category else 'Clothing' }}</p>
                              {% if swap.item1.points_required %}
                              <span class="swap-item-points">
                                <span class="material-symbols-outlined">stars</span>
                                {{ swap.item1.points_required }} points value
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        
                        <div class="swap-arrow-container">
                          <div class="swap-arrow">
                            <span class="material-symbols-outlined">swap_horiz</span>
                          </div>
                          <span class="swap-arrow-label">Exchanged</span>
                        </div>
                        
                        <div class="swap-item their-item">
                          <div class="swap-item-header">
                            <span class="material-symbols-outlined">person_outline</span>
                            <span class="swap-item-owner">{{ swap.user2.username }}'s Item</span>
                          </div>
                          <div class="swap-item-content">
                            <img src="{{ swap.item2.image_url }}" alt="{{ swap.item2.name }}" class="swap-item-image">
                            <div class="swap-item-details">
                              <h4 class="swap-item-name">{{ swap.item2.name }}</h4>
                              <p class="swap-item-category">{{ swap.item2.category.name if swap.item2.category else 'Clothing' }}</p>
                              {% if swap.item2.points_required %}
                              <span class="swap-item-points">
                                <span class="material-symbols-outlined">stars</span>
                                {{ swap.item2.points_required }} points value
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="swap-item-pair">
                        <div class="swap-item my-item">
                          <div class="swap-item-header">
                            <span class="material-symbols-outlined">person</span>
                            <span class="swap-item-owner">Your Item</span>
                          </div>
                          <div class="swap-item-content">
                            <img src="{{ swap.item2.image_url }}" alt="{{ swap.item2.name }}" class="swap-item-image">
                            <div class="swap-item-details">
                              <h4 class="swap-item-name">{{ swap.item2.name }}</h4>
                              <p class="swap-item-category">{{ swap.item2.category.name if swap.item2.category else 'Clothing' }}</p>
                              {% if swap.item2.points_required %}
                              <span class="swap-item-points">
                                <span class="material-symbols-outlined">stars</span>
                                {{ swap.item2.points_required }} points value
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        
                        <div class="swap-arrow-container">
                          <div class="swap-arrow">
                            <span class="material-symbols-outlined">swap_horiz</span>
                          </div>
                          <span class="swap-arrow-label">Exchanged</span>
                        </div>
                        
                        <div class="swap-item their-item">
                          <div class="swap-item-header">
                            <span class="material-symbols-outlined">person_outline</span>
                            <span class="swap-item-owner">{{ swap.user1.username }}'s Item</span>
                          </div>
                          <div class="swap-item-content">
                            <img src="{{ swap.item1.image_url }}" alt="{{ swap.item1.name }}" class="swap-item-image">
                            <div class="swap-item-details">
                              <h4 class="swap-item-name">{{ swap.item1.name }}</h4>
                              <p class="swap-item-category">{{ swap.item1.category.name if swap.item1.category else 'Clothing' }}</p>
                              {% if swap.item1.points_required %}
                              <span class="swap-item-points">
                                <span class="material-symbols-outlined">stars</span>
                                {{ swap.item1.points_required }} points value
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="swap-footer">
                    <div class="swap-actions">
                      <button class="action-btn secondary" onclick="viewSwapDetails({{ swap.id }})">
                        <span class="material-symbols-outlined">visibility</span>
                        View Details
                      </button>
                      <button class="action-btn secondary" onclick="downloadSwapReceipt({{ swap.id }})">
                        <span class="material-symbols-outlined">download</span>
                        Receipt
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
                </div>
                
                <!-- Carousel Indicators -->
                <div class="carousel-indicators">
                  {% for swap in user_swaps %}
                  <button class="indicator {% if loop.index0 == 0 %}active{% endif %}" 
                          onclick="goToSwap({{ loop.index0 }})" 
                          data-swap-target="{{ loop.index0 }}">
                  </button>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">swap_horiz</span>
                <p>You haven't completed any swaps yet.</p>
                <button class="create-request-btn" onclick="showCreateRequestForm()">Add Item to Swap</button>
              </div>
            {% endif %}
          </div>
          
          <!-- Point Redemptions Section -->
          <div class="detail-section">
            <h3>Point Redemptions</h3>
            {% if point_redemptions and point_redemptions|length > 0 %}
              <div class="redemptions-list">
                {% for redemption in point_redemptions %}
                <div class="redemption-card">
                  <div class="redemption-header">
                    <span class="redemption-date">{{ redemption.redeemed_at.strftime('%B %d, %Y') }}</span>
                    <span class="points-spent">{{ redemption.points_spent }} points</span>
                  </div>
                  <div class="redemption-item">
                    <img src="{{ redemption.product.image_url }}" alt="{{ redemption.product.name }}" class="redemption-item-image">
                    <div class="redemption-item-details">
                      <p class="redemption-item-name">{{ redemption.product.name }}</p>
                      <p class="redemption-item-category">{{ redemption.product.category.name }}</p>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">stars</span>
                <p>You haven't redeemed any points yet.</p>
                <a href="{{ url_for('main.home') }}" class="shop-now-btn">Browse Items</a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Add Item Tab -->
        <div class="tab-pane" id="add-item">
          <div class="detail-section">
            <h3>Add New Item to ReWear</h3>
            <p class="section-description">Add clothing items you want to exchange or sell for points on the ReWear platform.</p>
            <div class="add-item-form">
              <form id="add-item-form">
                <div class="form-group">
                  <label for="item-name">Item Name</label>
                  <input type="text" id="item-name" name="name" placeholder="e.g., Vintage Denim Jacket" required>
                </div>
                <div class="form-group">
                  <label for="item-description">Description</label>
                  <textarea id="item-description" name="description" rows="4" placeholder="Describe the item condition, size, brand, and any other relevant details..." required></textarea>
                </div>
                <div class="form-group">
                  <label for="item-points">Points Required</label>
                  <input type="number" id="item-points" name="points" min="1" placeholder="How many points should this item cost?" required>
                  <small class="form-help">Consider the item's condition, brand, and desirability when setting points.</small>
                </div>
                <div class="form-group">
                  <label for="item-category">Category</label>
                  <select id="item-category" name="category_id" required>
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="item-image">Image URL</label>
                  <input type="url" id="item-image" name="image_url" placeholder="https://example.com/image.jpg">
                  <small class="form-help">Add a clear photo showing the item's condition and details.</small>
                </div>
                <div class="form-actions">
                  <button type="submit" class="save-button">Add Item to ReWear</button>
                  <button type="reset" class="cancel-button">Clear Form</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- My Uploaded Items Section -->
          <div class="detail-section">
            <h3>My Listed Items</h3>
            {% if uploaded_products and uploaded_products|length > 0 %}
              <div class="uploaded-items-list">
                {% for product in uploaded_products %}
                <div class="uploaded-item-card">
                  <img src="{{ product.image_url }}" alt="{{ product.name }}" class="uploaded-item-image">
                  <div class="uploaded-item-details">
                    <h4 class="uploaded-item-name">{{ product.name }}</h4>
                    <p class="uploaded-item-category">{{ product.category.name }}</p>
                    <div class="uploaded-item-meta">
                      <span class="uploaded-item-points">{{ product.points_required }} points</span>
                      <span class="uploaded-item-stock">{{ product.stock }} available</span>
                      <span class="approval-status {{ product.approval_status }}">
                        {% if product.approval_status == 'approved' %}
                          ‚úÖ Approved
                        {% elif product.approval_status == 'pending' %}
                          ‚è≥ Pending Approval
                        {% elif product.approval_status == 'rejected' %}
                          ‚ùå Rejected
                        {% endif %}
                      </span>
                    </div>
                    {% if product.approval_status == 'rejected' and product.rejection_reason %}
                      <p class="rejection-reason">Reason: {{ product.rejection_reason }}</p>
                    {% endif %}
                  </div>
                  <div class="uploaded-item-actions">
                    <button class="edit-item-btn" data-product-id="{{ product.id }}">
                      <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button class="remove-item-btn" data-product-id="{{ product.id }}">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">inventory_2</span>
                <p>You haven't uploaded any items yet.</p>
                <p>Start adding items to build your ReWear inventory!</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- My Redemptions Tab -->
        <div class="tab-pane" id="my-redemptions">
          <div class="detail-section">
            <h3>Point Redemptions History</h3>
            <p class="section-description">Track all your point redemptions and claimed items from the ReWear platform.</p>
            {% if point_redemptions and point_redemptions|length > 0 %}
              <div class="redemptions-list">
                {% for redemption in point_redemptions %}
                <div class="redemption-card">
                  <div class="redemption-header">
                    <span class="redemption-id">Redemption #{{ redemption.id }}</span>
                    <span class="redemption-date">{{ redemption.redeemed_at.strftime('%B %d, %Y') }}</span>
                    <span class="points-spent">{{ redemption.points_spent }} points</span>
                  </div>
                  <div class="redemption-item">
                    <img src="{{ redemption.product.image_url }}" alt="{{ redemption.product.name }}" class="redemption-item-image">
                    <div class="redemption-item-details">
                      <p class="redemption-item-name">{{ redemption.product.name }}</p>
                      <p class="redemption-item-category">{{ redemption.product.category.name }}</p>
                      <div class="redemption-meta">
                        <span class="redemption-status">‚úÖ Claimed</span>
                        <span class="redemption-value">Worth {{ redemption.points_spent }} points</span>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <!-- Summary Stats -->
              <div class="redemption-summary">
                <h4>Redemption Summary</h4>
                <div class="summary-stats">
                  <div class="summary-stat">
                    <span class="stat-label">Total Redemptions:</span>
                    <span class="stat-value">{{ point_redemptions|length }}</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-label">Total Points Spent:</span>
                    <span class="stat-value">{{ point_redemptions|sum(attribute='points_spent') }} points</span>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">stars</span>
                <p>You haven't redeemed any points yet.</p>
                <p>Start earning points through swaps and redeem them for amazing clothing items!</p>
                <a href="{{ url_for('main.home') }}" class="shop-now-btn">Browse Items to Redeem</a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Personal Info Tab (includes addresses) -->
        <div class="tab-pane" id="personal-info">
          <div class="detail-section">
            <h3>Personal Information</h3>
            <div id="personal-info-display">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Username</span>
                  <span class="info-value">{{ current_user.username }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Email</span>
                  <span class="info-value">{{ current_user.email }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Phone</span>
                  <span class="info-value">{{ current_user.phone or 'Not set' }}</span>
                </div>
              </div>
            </div>
            
            <form id="personal-info-form" style="display: none;">
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" value="{{ current_user.username }}" required>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ current_user.email }}" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" value="{{ current_user.phone or '' }}">
              </div>
              <div class="form-actions">
                <button type="submit" class="save-button">Save Changes</button>
                <button type="button" class="cancel-button" id="cancel-edit-btn">Cancel</button>
              </div>
            </form>
            <div id="flash-messages"></div>
          </div>

          <!-- Addresses Section -->
          <div class="detail-section">
            <h3>Your Addresses</h3>
            {% if addresses and addresses|length > 0 %}
              <div class="addresses-grid">
                {% for address in addresses %}
                <div class="address-card {% if address.is_default %}default{% endif %}">
                  {% if address.is_default %}
                  <span class="default-badge">Default</span>
                  {% endif %}
                  <h4>{{ address.address_type|title }}</h4>
                  <p>{{ current_user.username }}</p>
                  {% if address.company_name %}
                  <p>{{ address.company_name }}</p>
                  {% endif %}
                  <p>{{ address.street_address }}</p>
                  {% if address.apartment %}
                  <p>{{ address.apartment }}</p>
                  {% endif %}
                  <p>{{ address.city }}, {{ address.state }}, {{ address.pin_code }}</p>
                  <p>{{ address.country }}</p>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">home</span>
                <p>You haven't added any addresses yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'footer.html' %}

  <nav class="mobile-bottom-nav">
    <a href="{{ url_for('main.home') }}" class="{% if request.endpoint == 'main.home' %}active{% endif %}">
      <span class="material-symbols-outlined">home</span>
      <span>Home</span>
    </a>
    <a href="{{ url_for('main.search') }}" class="{% if request.endpoint == 'main.search' %}active{% endif %}">
      <span class="material-symbols-outlined">search</span>
      <span>Search</span>
    </a>
    <a href="{{ url_for('main.wishlist') }}" class="{% if request.endpoint == 'main.wishlist' %}active{% endif %}">
      <span class="material-symbols-outlined">favorite</span>
      <span>Wishlist</span>
    </a>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('main.profile') }}" class="{% if request.endpoint == 'main.profile' %}active{% endif %}">
        <span class="material-symbols-outlined">person</span>
        <span>Profile</span>
      </a>
    {% else %}
      <a href="{{ url_for('main.signin') }}" class="{% if request.endpoint == 'main.signin' %}active{% endif %}">
        <span class="material-symbols-outlined">login</span>
        <span>Login</span>
      </a>
    {% endif %}
  </nav>

  <script src="https://kit.fontawesome.com/51c1e7b4cb.js" crossorigin="anonymous"></script>
  <!-- Load the external JavaScript file -->
  <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
  
  <script>
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabPanes = document.querySelectorAll('.tab-pane');

      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons and panes
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanes.forEach(pane => pane.classList.remove('active'));

          // Add active class to clicked button
          this.classList.add('active');

          // Show the corresponding tab pane
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });
    });

    function showCreateRequestForm() {
      // Switch to Add Item tab
      document.querySelector('[data-tab="add-item"]').click();
    }

    // Function to refresh points balance
    function refreshPoints() {
      const refreshBtn = document.getElementById('refresh-points-btn');
      const pointsDisplay = document.getElementById('points-display');
      
      // Add loading state
      refreshBtn.style.animation = 'spin 1s linear infinite';
      
      fetch('/refresh-points')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            pointsDisplay.textContent = data.points_balance;
            // Show success indicator
            pointsDisplay.style.color = '#4caf50';
            setTimeout(() => {
              pointsDisplay.style.color = '';
            }, 2000);
          } else {
            console.error('Failed to refresh points:', data.message);
          }
        })
        .catch(error => {
          console.error('Error refreshing points:', error);
        })
        .finally(() => {
          // Remove loading state
          refreshBtn.style.animation = '';
        });
    }

    // CSS animation for spin
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);

    // Swap action functions
    function viewSwapDetails(swapId) {
      // Create a modal or detailed view for the swap
      alert(`Viewing details for Swap #${swapId}. This feature will show complete swap history, messaging, and transaction details.`);
      // TODO: Implement detailed swap view modal
    }

    function downloadSwapReceipt(swapId) {
      // Generate and download swap receipt
      alert(`Downloading receipt for Swap #${swapId}. This will generate a PDF receipt with swap details.`);
      // TODO: Implement receipt generation and download
    }

    // Carousel functionality for swaps
    let currentSwapIndex = 0;
    const totalSwaps = document.querySelectorAll('.swap-card').length;

    function updateSwapDisplay() {
      // Hide all swap cards
      document.querySelectorAll('.swap-card').forEach((card, index) => {
        card.style.display = index === currentSwapIndex ? 'block' : 'none';
      });

      // Update indicators
      document.querySelectorAll('.indicator').forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentSwapIndex);
      });

      // Update counter
      document.getElementById('current-swap-index').textContent = currentSwapIndex + 1;

      // Update button states
      document.getElementById('prev-swap').disabled = currentSwapIndex === 0;
      document.getElementById('next-swap').disabled = currentSwapIndex === totalSwaps - 1;
    }

    function nextSwap() {
      if (currentSwapIndex < totalSwaps - 1) {
        currentSwapIndex++;
        updateSwapDisplay();
      }
    }

    function previousSwap() {
      if (currentSwapIndex > 0) {
        currentSwapIndex--;
        updateSwapDisplay();
      }
    }

    function goToSwap(index) {
      currentSwapIndex = index;
      updateSwapDisplay();
    }

    // Initialize carousel on page load
    document.addEventListener('DOMContentLoaded', function() {
      if (totalSwaps > 0) {
        updateSwapDisplay();
        
        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
          // Only work if we're on the swap history tab
          const swapTab = document.getElementById('swap-requests');
          if (swapTab && swapTab.classList.contains('active')) {
            if (e.key === 'ArrowLeft') {
              e.preventDefault();
              previousSwap();
            } else if (e.key === 'ArrowRight') {
              e.preventDefault();
              nextSwap();
            }
          }
        });

        // Add touch/swipe support for mobile
        let startX = 0;
        let endX = 0;
        const carousel = document.querySelector('.swaps-carousel');
        
        if (carousel) {
          carousel.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
          });

          carousel.addEventListener('touchend', function(e) {
            endX = e.changedTouches[0].clientX;
            handleSwipe();
          });

          function handleSwipe() {
            const swipeThreshold = 50;
            const diff = startX - endX;
            
            if (Math.abs(diff) > swipeThreshold) {
              if (diff > 0) {
                // Swiped left, go to next
                nextSwap();
              } else {
                // Swiped right, go to previous
                previousSwap();
              }
            }
          }
        }
      }
    });
  </script>
</body>

</html>