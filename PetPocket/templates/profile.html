<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReWear - Profile</title>
  <!-- Add CSRF token meta tag before other resources -->
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{url_for('static', filename='css/navbar.css')}}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=Inter:wght@800&display=swap" rel="stylesheet">
  <style>
    body, .tab-content, .info-value, .detail-section, .addresses-grid, .address-card, .purchase-card, .purchase-item, .add-item-form, .stat-content p, .points-bar, .tab-button, .shop-now-btn, .create-request-btn {
      font-family: 'Crimson Pro', serif !important;
    }
    h1, h2, h3, .profile-username, .detail-section h3, .stat-content h4, .default-badge, .tab-header, .stat-card span.material-symbols-outlined {
      font-family: 'Inter', sans-serif !important;
      font-weight: 800 !important;
      letter-spacing: -0.5px;
    }
  </style>
</head>

<body>
  {% include 'navbar.html' %}
  
  <div class="profile-container">
    <!-- Profile Header with Points -->
    <div class="profile-header">
      <div class="profile-hero">
        <div class="profile-avatar">
          {% if current_user.profile_picture %}
            <img src="{{ current_user.profile_picture }}" alt="{{ current_user.username }}" class="profile-photo">
          {% else %}
            <span class="material-symbols-outlined profile-icon">pets</span>
          {% endif %}
        </div>
        <div class="profile-main-info">
          <div class="profile-header-row">
            <h2 class="profile-username">{{ current_user.username }}</h2>
            <button class="edit-button" id="edit-profile-btn">
              <span class="material-symbols-outlined">edit</span> Edit Profile
            </button>
          </div>
          <div class="points-bar">
            <span class="points-label">Points:</span>
            <span class="points-value">{{ current_user.points_balance }}</span>
            <span class="points-icon">🪙</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="profile-tabs">
      <div class="tab-header">
        <button class="tab-button active" data-tab="dashboard">
          <span class="material-symbols-outlined">dashboard</span>
          Dashboard
        </button>
        <button class="tab-button" data-tab="swap-requests">
          <span class="material-symbols-outlined">swap_horiz</span>
          Swap History
        </button>
        <button class="tab-button" data-tab="add-item">
          <span class="material-symbols-outlined">add_circle</span>
          List Items
        </button>
        <button class="tab-button" data-tab="my-purchases">
          <span class="material-symbols-outlined">shopping_bag</span>
          Redemptions
        </button>
        <button class="tab-button" data-tab="personal-info">
          <span class="material-symbols-outlined">person</span>
          Personal Info
        </button>
      </div>

      <div class="tab-content">
        <!-- Dashboard Tab -->
        <div class="tab-pane active" id="dashboard">
          <div class="detail-section">
            <h3>Dashboard Overview</h3>
            <div class="dashboard-stats">
              <div class="stat-card">
                <span class="material-symbols-outlined">shopping_cart</span>
                <div class="stat-content">
                  <h4>{{ orders|length if orders else 0 }}</h4>
                  <p>Total Purchases</p>
                </div>
              </div>
              <div class="stat-card">
                <span class="material-symbols-outlined">favorite</span>
                <div class="stat-content">
                  <h4>{{ wishlist_items|length if wishlist_items else 0 }}</h4>
                  <p>Wishlist Items</p>
                </div>
              </div>

              <div class="stat-card">
                <span class="material-symbols-outlined">swap_horiz</span>
                <div class="stat-content">
                  <h4>{{ user_swaps|length if user_swaps else 0 }}</h4>
                  <p>Completed Swaps</p>
                </div>
              </div>
              
              <div class="stat-card">
                <span class="material-symbols-outlined">stars</span>
                <div class="stat-content">
                  <h4>{{ point_redemptions|length if point_redemptions else 0 }}</h4>
                  <p>Point Redemptions</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="detail-section">
            <h3>Recent Activity</h3>
            <div class="activity-list">
              {% if recent_activity %}
                {% for activity in recent_activity %}
                <div class="activity-item">
                  <span class="activity-icon material-symbols-outlined">{{ activity.icon }}</span>
                  <div class="activity-content">
                    <p class="activity-text">{{ activity.text }}</p>
                    <span class="activity-time">{{ activity.time }}</span>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="empty-state">
                  <span class="material-symbols-outlined">timeline</span>
                  <p>No recent activity.</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Swap Requests Tab -->
        <div class="tab-pane" id="swap-requests">
          <div class="detail-section">
            <h3>My Swap History</h3>
            {% if user_swaps and user_swaps|length > 0 %}
              <div class="swaps-list">
                {% for swap in user_swaps %}
                <div class="swap-card">
                  <div class="swap-header">
                    <span class="swap-id">Swap #{{ swap.id }}</span>
                    <span class="swap-date">{{ swap.completed_at.strftime('%B %d, %Y') }}</span>
                    <span class="swap-status completed">✅ Completed</span>
                  </div>
                  <div class="swap-items">
                    {% if swap.user1_id == current_user.id %}
                      <div class="swap-item-pair">
                        <div class="swap-item my-item">
                          <img src="{{ swap.item1.image_url }}" alt="{{ swap.item1.name }}" class="swap-item-image">
                          <div class="swap-item-details">
                            <p class="swap-item-name">{{ swap.item1.name }}</p>
                            <p class="swap-item-label">Your Item</p>
                          </div>
                        </div>
                        <div class="swap-arrow">⇄</div>
                        <div class="swap-item their-item">
                          <img src="{{ swap.item2.image_url }}" alt="{{ swap.item2.name }}" class="swap-item-image">
                          <div class="swap-item-details">
                            <p class="swap-item-name">{{ swap.item2.name }}</p>
                            <p class="swap-item-label">{{ swap.user2.username }}'s Item</p>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="swap-item-pair">
                        <div class="swap-item my-item">
                          <img src="{{ swap.item2.image_url }}" alt="{{ swap.item2.name }}" class="swap-item-image">
                          <div class="swap-item-details">
                            <p class="swap-item-name">{{ swap.item2.name }}</p>
                            <p class="swap-item-label">Your Item</p>
                          </div>
                        </div>
                        <div class="swap-arrow">⇄</div>
                        <div class="swap-item their-item">
                          <img src="{{ swap.item1.image_url }}" alt="{{ swap.item1.name }}" class="swap-item-image">
                          <div class="swap-item-details">
                            <p class="swap-item-name">{{ swap.item1.name }}</p>
                            <p class="swap-item-label">{{ swap.user1.username }}'s Item</p>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">swap_horiz</span>
                <p>You haven't completed any swaps yet.</p>
                <button class="create-request-btn" onclick="showCreateRequestForm()">Add Item to Swap</button>
              </div>
            {% endif %}
          </div>
          
          <!-- Point Redemptions Section -->
          <div class="detail-section">
            <h3>Point Redemptions</h3>
            {% if point_redemptions and point_redemptions|length > 0 %}
              <div class="redemptions-list">
                {% for redemption in point_redemptions %}
                <div class="redemption-card">
                  <div class="redemption-header">
                    <span class="redemption-date">{{ redemption.redeemed_at.strftime('%B %d, %Y') }}</span>
                    <span class="points-spent">{{ redemption.points_spent }} points</span>
                  </div>
                  <div class="redemption-item">
                    <img src="{{ redemption.product.image_url }}" alt="{{ redemption.product.name }}" class="redemption-item-image">
                    <div class="redemption-item-details">
                      <p class="redemption-item-name">{{ redemption.product.name }}</p>
                      <p class="redemption-item-category">{{ redemption.product.category.name }}</p>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">stars</span>
                <p>You haven't redeemed any points yet.</p>
                <a href="{{ url_for('main.home') }}" class="shop-now-btn">Browse Items</a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Add Item Tab -->
        <div class="tab-pane" id="add-item">
          <div class="detail-section">
            <h3>Add New Item to ReWear</h3>
            <p class="section-description">Add clothing items you want to exchange or sell for points on the ReWear platform.</p>
            <div class="add-item-form">
              <form id="add-item-form">
                <div class="form-group">
                  <label for="item-name">Item Name</label>
                  <input type="text" id="item-name" name="name" placeholder="e.g., Vintage Denim Jacket" required>
                </div>
                <div class="form-group">
                  <label for="item-description">Description</label>
                  <textarea id="item-description" name="description" rows="4" placeholder="Describe the item condition, size, brand, and any other relevant details..." required></textarea>
                </div>
                <div class="form-group">
                  <label for="item-points">Points Required</label>
                  <input type="number" id="item-points" name="points" min="1" placeholder="How many points should this item cost?" required>
                  <small class="form-help">Consider the item's condition, brand, and desirability when setting points.</small>
                </div>
                <div class="form-group">
                  <label for="item-category">Category</label>
                  <select id="item-category" name="category_id" required>
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="item-image">Image URL</label>
                  <input type="url" id="item-image" name="image_url" placeholder="https://example.com/image.jpg">
                  <small class="form-help">Add a clear photo showing the item's condition and details.</small>
                </div>
                <div class="form-actions">
                  <button type="submit" class="save-button">Add Item to ReWear</button>
                  <button type="reset" class="cancel-button">Clear Form</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- My Uploaded Items Section -->
          <div class="detail-section">
            <h3>My Listed Items</h3>
            {% if uploaded_products and uploaded_products|length > 0 %}
              <div class="uploaded-items-list">
                {% for product in uploaded_products %}
                <div class="uploaded-item-card">
                  <img src="{{ product.image_url }}" alt="{{ product.name }}" class="uploaded-item-image">
                  <div class="uploaded-item-details">
                    <h4 class="uploaded-item-name">{{ product.name }}</h4>
                    <p class="uploaded-item-category">{{ product.category.name }}</p>
                    <div class="uploaded-item-meta">
                      <span class="uploaded-item-points">{{ product.points_required }} points</span>
                      <span class="uploaded-item-stock">{{ product.stock }} available</span>
                    </div>
                  </div>
                  <div class="uploaded-item-actions">
                    <button class="edit-item-btn" data-product-id="{{ product.id }}">
                      <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button class="remove-item-btn" data-product-id="{{ product.id }}">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">inventory_2</span>
                <p>You haven't uploaded any items yet.</p>
                <p>Start adding items to build your ReWear inventory!</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- My Purchases/Redemptions Tab -->
        <div class="tab-pane" id="my-purchases">
          <div class="detail-section">
            <h3>Purchase History</h3>
            {% if orders and orders|length > 0 %}
              <div class="purchases-list">
                {% for order in orders %}
                <div class="purchase-card">
                  <div class="purchase-header">
                    <span class="purchase-id">Order #{{ order.id }}</span>
                    <span class="purchase-date">{{ order.timestamp.strftime('%B %d, %Y') }}</span>
                    <span class="purchase-status {{ order.payment_status }}">
                      {% if order.payment_status == 'completed' %}
                        ✅ Completed
                      {% elif order.payment_status == 'pending' %}
                        ⏳ Pending
                      {% else %}
                        {{ order.payment_status|title }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="purchase-items">
                    {% for item in order.items %}
                    <div class="purchase-item">
                      <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="purchase-item-image">
                      <div class="purchase-item-details">
                        <p class="purchase-item-name">{{ item.product.name }}</p>
                        <p class="purchase-item-price">Rs.{{ item.price_at_purchase }} x {{ item.quantity }}</p>
                        {% if item.product.points_required %}
                        <p class="purchase-item-points">{{ item.product.points_required }} points each</p>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <div class="purchase-footer">
                    <span class="purchase-total">Total: Rs.{{ '%.2f'|format(order.total_price) }}</span>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">shopping_bag</span>
                <p>You haven't made any purchases yet.</p>
                <a href="{{ url_for('main.home') }}" class="shop-now-btn">Browse ReWear Items</a>
              </div>
            {% endif %}
          </div>
          
          <!-- Point Redemptions in Purchases Tab -->
          {% if point_redemptions and point_redemptions|length > 0 %}
          <div class="detail-section">
            <h3>Point Redemptions</h3>
            <div class="redemptions-list">
              {% for redemption in point_redemptions %}
              <div class="redemption-card">
                <div class="redemption-header">
                  <span class="redemption-id">Redemption #{{ redemption.id }}</span>
                  <span class="redemption-date">{{ redemption.redeemed_at.strftime('%B %d, %Y') }}</span>
                  <span class="points-spent">{{ redemption.points_spent }} points</span>
                </div>
                <div class="redemption-item">
                  <img src="{{ redemption.product.image_url }}" alt="{{ redemption.product.name }}" class="redemption-item-image">
                  <div class="redemption-item-details">
                    <p class="redemption-item-name">{{ redemption.product.name }}</p>
                    <p class="redemption-item-category">{{ redemption.product.category.name }}</p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Personal Info Tab (includes addresses) -->
        <div class="tab-pane" id="personal-info">
          <div class="detail-section">
            <h3>Personal Information</h3>
            <div id="personal-info-display">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Username</span>
                  <span class="info-value">{{ current_user.username }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Email</span>
                  <span class="info-value">{{ current_user.email }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Phone</span>
                  <span class="info-value">{{ current_user.phone or 'Not set' }}</span>
                </div>
              </div>
            </div>
            
            <form id="personal-info-form" style="display: none;">
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" value="{{ current_user.username }}" required>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ current_user.email }}" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" value="{{ current_user.phone or '' }}">
              </div>
              <div class="form-actions">
                <button type="submit" class="save-button">Save Changes</button>
                <button type="button" class="cancel-button" id="cancel-edit-btn">Cancel</button>
              </div>
            </form>
            <div id="flash-messages"></div>
          </div>

          <!-- Addresses Section -->
          <div class="detail-section">
            <h3>Your Addresses</h3>
            {% if addresses and addresses|length > 0 %}
              <div class="addresses-grid">
                {% for address in addresses %}
                <div class="address-card {% if address.is_default %}default{% endif %}">
                  {% if address.is_default %}
                  <span class="default-badge">Default</span>
                  {% endif %}
                  <h4>{{ address.address_type|title }}</h4>
                  <p>{{ current_user.username }}</p>
                  {% if address.company_name %}
                  <p>{{ address.company_name }}</p>
                  {% endif %}
                  <p>{{ address.street_address }}</p>
                  {% if address.apartment %}
                  <p>{{ address.apartment }}</p>
                  {% endif %}
                  <p>{{ address.city }}, {{ address.state }}, {{ address.pin_code }}</p>
                  <p>{{ address.country }}</p>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <span class="material-symbols-outlined">home</span>
                <p>You haven't added any addresses yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'footer.html' %}

  <nav class="mobile-bottom-nav">
    <a href="{{ url_for('main.home') }}" class="{% if request.endpoint == 'main.home' %}active{% endif %}">
      <span class="material-symbols-outlined">home</span>
      <span>Home</span>
    </a>
    <a href="{{ url_for('main.search') }}" class="{% if request.endpoint == 'main.search' %}active{% endif %}">
      <span class="material-symbols-outlined">search</span>
      <span>Search</span>
    </a>
    <a href="{{ url_for('main.wishlist') }}" class="{% if request.endpoint == 'main.wishlist' %}active{% endif %}">
      <span class="material-symbols-outlined">favorite</span>
      <span>Wishlist</span>
    </a>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('main.profile') }}" class="{% if request.endpoint == 'main.profile' %}active{% endif %}">
        <span class="material-symbols-outlined">person</span>
        <span>Profile</span>
      </a>
    {% else %}
      <a href="{{ url_for('main.signin') }}" class="{% if request.endpoint == 'main.signin' %}active{% endif %}">
        <span class="material-symbols-outlined">login</span>
        <span>Login</span>
      </a>
    {% endif %}
  </nav>

  <script src="https://kit.fontawesome.com/51c1e7b4cb.js" crossorigin="anonymous"></script>
  <!-- Load the external JavaScript file -->
  <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
  
  <script>
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabPanes = document.querySelectorAll('.tab-pane');

      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons and panes
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanes.forEach(pane => pane.classList.remove('active'));

          // Add active class to clicked button
          this.classList.add('active');

          // Show the corresponding tab pane
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });
    });

    function showCreateRequestForm() {
      // Switch to Add Item tab
      document.querySelector('[data-tab="add-item"]').click();
    }
  </script>
</body>

</html>